<!doctype html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≤‡∏ü -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { box-sizing: border-box; font-family: 'Sarabun','Noto Sans Thai',sans-serif; }
    * { box-sizing: border-box; }
    .status-present { background-color: #dcfce7; }
    .status-absent  { background-color: #fee2e2; }
    .status-late    { background-color: #fed7aa; }
    .status-leave   { background-color: #fef9c3; }
    .btn-status { transition: all 0.2s; }
    .btn-status:hover { transform: scale(1.05); }

    .modal {
      display: none; position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 1000;
    }
    .modal.active { display: flex; align-items: center; justify-content: center; }

    .loading { display: none; }
    .loading.active {
      display: inline-block;
      width: 16px; height: 16px;
      border: 2px solid #ffffff;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .card-shadow { box-shadow: 0 10px 25px rgba(15,23,42,0.08); }
  </style>
</head>

<body class="w-full min-h-full bg-gradient-to-br from-blue-50 to-indigo-100">
  <div class="w-full min-h-full p-6 max-w-6xl mx-auto">

    <!-- Header -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div>
        <h1 class="text-3xl font-bold text-indigo-900 mb-2" id="company-name">Gosoft.co.th</h1>
        <p class="text-xl text-indigo-700" id="department-name">Techncal service support</p>
        <p class="text-lg text-gray-600">Head of Unit: <span id="manager-name">Putinan Suramarna</span></p>
        <p class="text-xl text-indigo-700">Cloud Implementation</p>
        <p class="text-lg text-gray-600">Head of Unit: <span>Prawit Tangmanopeanchai</span></p>
      </div>
      <div class="text-right">
        <p class="text-sm text-gray-500">‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</p>
        <p class="text-base font-semibold text-gray-800" id="current-time"></p>
      </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="bg-white rounded-lg shadow-md mb-6">
      <div class="flex border-b overflow-x-auto">
        <button class="tab-btn px-6 py-3 font-semibold text-indigo-600 border-b-2 border-indigo-600 whitespace-nowrap" data-tab="attendance">‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</button>
        <button class="tab-btn px-6 py-3 font-semibold text-gray-600 hover:text-indigo-600 whitespace-nowrap" data-tab="employees">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</button>
        <button class="tab-btn px-6 py-3 font-semibold text-gray-600 hover:text-indigo-600 whitespace-nowrap" data-tab="history">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</button>
        <button class="tab-btn px-6 py-3 font-semibold text-gray-600 hover:text-indigo-600 whitespace-nowrap" data-tab="summary">‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</button>
      </div>
    </div>

    <!-- Attendance Tab -->
    <div id="tab-attendance" class="tab-content">
      <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="flex items-center gap-4 mb-4">
          <label class="font-semibold text-gray-700">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
          <input type="date" id="attendance-date" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
          <span class="text-gray-600" id="current-time-inline"></span>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
          <div class="bg-green-100 p-3 rounded-lg text-center">
            <div class="text-2xl font-bold text-green-700" id="count-present">0</div>
            <div class="text-sm text-gray-600">‡πÄ‡∏Ç‡πâ‡∏≤ office</div>
          </div>
          <div class="bg-red-100 p-3 rounded-lg text-center">
            <div class="text-2xl font-bold text-red-700" id="count-absent">0</div>
            <div class="text-sm text-gray-600">wfh</div>
          </div>
          <div class="bg-yellow-100 p-3 rounded-lg text-center">
            <div class="text-2xl font-bold text-yellow-700" id="count-leave">0</div>
            <div class="text-sm text-gray-600">‡∏•‡∏≤‡∏á‡∏≤‡∏ô</div>
          </div>
          <div class="bg-orange-100 p-3 rounded-lg text-center">
            <div class="text-2xl font-bold text-orange-700" id="count-late">0</div>
            <div class="text-sm text-gray-600">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≤‡∏¢</div>
          </div>
        </div>
      </div>

      <div id="attendance-list" class="space-y-3"></div>

      <div class="mt-6">
        <button id="save-attendance-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg flex items-center justify-center gap-2">
          <span class="loading"></span>
          <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</span>
        </button>
      </div>
    </div>

    <!-- Employees Management Tab -->
    <div id="tab-employees" class="tab-content hidden">
      <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-2xl font-bold text-indigo-900 mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h2>
        <form id="add-employee-form" class="space-y-4">
          <div>
            <label class="block text-gray-700 font-semibold mb-2">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
            <input type="text" id="new-employee-id" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="123456" required>
          </div>
          <div>
            <label class="block text-gray-700 font-semibold mb-2">‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
            <input type="text" id="new-employee-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà 1" required>
          </div>
          <div>
            <label class="block text-gray-700 font-semibold mb-2">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label>
            <input type="text" id="new-employee-position" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á" required>
          </div>
          <div>
            <label class="block text-gray-700 font-semibold mb-2">‡πÅ‡∏ú‡∏ô‡∏Å</label>
            <input type="text" id="new-employee-department" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="‡πÅ‡∏ú‡∏ô‡∏Å" required>
          </div>

          <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg flex items-center justify-center gap-2">
            <span class="loading"></span>
            <span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</span>
          </button>
        </form>
      </div>

      <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-2xl font-bold text-indigo-900 mb-4">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h2>
        <div id="employees-list" class="space-y-3"></div>
      </div>
    </div>

    <!-- History Tab -->
    <div id="tab-history" class="tab-content hidden">
      <div class="bg-white rounded-2xl card-shadow p-6 mb-6">
        <h2 class="text-2xl font-bold text-indigo-900 mb-4">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</h2>

        <div class="flex flex-col lg:flex-row gap-4 lg:items-end lg:justify-between mb-4">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
            <div class="flex flex-col gap-1">
              <label for="history-date" class="text-xs font-semibold text-gray-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
              <input type="date" id="history-date" class="w-full px-3 py-2 rounded-lg border border-gray-300 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />
            </div>
            <div class="flex flex-col gap-1">
              <label for="history-status" class="text-xs font-semibold text-gray-600">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
              <select id="history-status" class="w-full px-3 py-2 rounded-lg border border-gray-300 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                <option value="present">‡πÄ‡∏Ç‡πâ‡∏≤ office</option>
                <option value="absent">wfh</option>
                <option value="leave">‡∏•‡∏≤</option>
                <option value="late">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≤‡∏¢</option>
              </select>
            </div>
            <div class="flex flex-col gap-1">
              <label for="history-dept" class="text-xs font-semibold text-gray-600">‡πÅ‡∏ú‡∏ô‡∏Å</label>
              <select id="history-dept" class="w-full px-3 py-2 rounded-lg border border-gray-300 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                <option value="Technical support">Technical support</option>
                <option value="Cloud Engineer">Cloud Engineer</option>
              </select>
            </div>
            <div class="flex flex-col gap-1">
              <label for="history-search" class="text-xs font-semibold text-gray-600">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ / ‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
              <div class="relative">
                <input type="text" id="history-search" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô..." class="w-full pl-9 pr-3 py-2 rounded-lg border border-gray-300 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />
                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm">üîç</span>
              </div>
            </div>
          </div>
        </div>

        <div class="overflow-x-auto border border-gray-100 rounded-xl">
          <table class="min-w-full text-sm">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-3 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wide">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                <th class="px-3 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wide">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th>
                <th class="px-3 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wide">‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th>
                <th class="px-3 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wide">‡πÅ‡∏ú‡∏ô‡∏Å</th>
                <th class="px-3 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wide">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤</th>
                <th class="px-3 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wide">‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å</th>
                <th class="px-3 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wide">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                <th class="px-3 py-3 text-right text-xs font-semibold text-gray-500 uppercase tracking-wide">‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</th>
              </tr>
            </thead>
            <tbody id="history-tbody" class="divide-y divide-gray-100"></tbody>
          </table>
        </div>

        <div class="mt-4 flex flex-col md:flex-row md:items-center md:justify-between gap-2 text-xs md:text-sm text-gray-500">
          <p id="history-summary-text"></p>
          <div class="flex items-center gap-2 justify-end">
            <button id="history-prev" class="px-3 py-1.5 rounded-lg border border-gray-300 hover:bg-gray-50 disabled:opacity-40 disabled:cursor-not-allowed">‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
            <span id="history-page-label"></span>
            <button id="history-next" class="px-3 py-1.5 rounded-lg border border-gray-300 hover:bg-gray-50 disabled:opacity-40 disabled:cursor-not-allowed">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Summary Tab -->
    <div id="tab-summary" class="tab-content hidden">
      <div class="grid gap-4 md:gap-6">

        <div class="bg-white rounded-lg shadow-md p-6">
          <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
            <div>
              <h2 class="text-2xl font-bold text-indigo-900 mb-1">‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h2>
              <p class="text-gray-600">‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‡πÅ‡∏•‡∏∞‡πÅ‡∏ú‡∏ô‡∏Å ‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>
              <p id="summary-range-label" class="text-xs text-gray-400 mt-2"></p>
            </div>
            <div class="flex flex-col sm:flex-row gap-2 items-start sm:items-end">
              <div class="flex flex-col gap-1">
                <label class="text-xs font-semibold text-gray-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                <input type="date" id="summary-start-date" class="px-3 py-2 rounded-lg border border-gray-300 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />
              </div>
              <div class="flex flex-col gap-1">
                <label class="text-xs font-semibold text-gray-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
                <input type="date" id="summary-end-date" class="px-3 py-2 rounded-lg border border-gray-300 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />
              </div>
              <div class="flex gap-2">
                <button id="summary-range-reset" class="mt-4 px-3 py-2 text-xs md:text-sm rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
              </div>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div class="bg-white rounded-2xl card-shadow px-4 py-3 flex flex-col gap-1">
            <p class="text-xs font-semibold text-gray-500">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á)</p>
            <p id="sum-total-emp" class="text-2xl font-bold text-gray-900">-</p>
            <p class="text-xs text-emerald-600">‡∏ô‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>
          </div>
          <div class="bg-white rounded-2xl card-shadow px-4 py-3 flex flex-col gap-1">
            <p class="text-xs font-semibold text-gray-500">‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏ï‡∏£‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)</p>
            <p id="sum-present-today" class="text-2xl font-bold text-emerald-600">-</p>
            <p class="text-xs text-gray-400">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô "‡∏ï‡∏£‡∏á‡πÄ‡∏ß‡∏•‡∏≤"</p>
          </div>
          <div class="bg-white rounded-2xl card-shadow px-4 py-3 flex flex-col gap-1">
            <p class="text-xs font-semibold text-gray-500">‡∏°‡∏≤‡∏™‡∏≤‡∏¢ (‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)</p>
            <p id="sum-late-today" class="text-2xl font-bold text-amber-500">-</p>
            <p class="text-xs text-amber-600">‡πÉ‡∏ä‡πâ‡∏î‡∏π‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡∏™‡∏≤‡∏¢‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°</p>
          </div>
          <div class="bg-white rounded-2xl card-shadow px-4 py-3 flex flex-col gap-1">
            <p class="text-xs font-semibold text-gray-500">‡∏•‡∏≤ / ‡∏Ç‡∏≤‡∏î (‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)</p>
            <p id="sum-leave-absent-today" class="text-2xl font-bold text-rose-500">-</p>
            <p class="text-xs text-rose-500">‡∏£‡∏ß‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ "‡∏•‡∏≤" ‡πÅ‡∏•‡∏∞ "‡∏Ç‡∏≤‡∏î"</p>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6">
          <div class="bg-white rounded-2xl card-shadow p-4">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-sm font-semibold text-gray-800">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô (‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)</h3>
              <span class="text-xs text-gray-400">‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</span>
            </div>
            <div class="h-64"><canvas id="chart-status-today"></canvas></div>
          </div>

          <div class="bg-white rounded-2xl card-shadow p-4">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-sm font-semibold text-gray-800">‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏°‡∏≤‡∏™‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)</h3>
              <span class="text-xs text-gray-400">‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ"</span>
            </div>
            <div class="h-64"><canvas id="chart-late-trend"></canvas></div>
          </div>
        </div>

        <div class="bg-white rounded-2xl card-shadow p-4 md:p-5 mb-6">
          <div class="flex items-center justify-between mb-3">
            <div>
              <h3 class="text-sm md:text-base font-semibold text-gray-900">‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô‡∏Å (‡∏≠‡∏¥‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)</h3>
              <p class="text-xs text-gray-400">‡πÉ‡∏ä‡πâ‡∏î‡∏π‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÅ‡∏ú‡∏ô‡∏Å‡πÉ‡∏ô‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£</p>
            </div>
          </div>

          <div class="overflow-x-auto border border-gray-100 rounded-xl">
            <table class="min-w-full text-sm">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-3 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wide">‡πÅ‡∏ú‡∏ô‡∏Å</th>
                  <th class="px-3 py-3 text-right text-xs font-semibold text-gray-500 uppercase tracking-wide">‡∏ï‡∏£‡∏á‡πÄ‡∏ß‡∏•‡∏≤</th>
                  <th class="px-3 py-3 text-right text-xs font-semibold text-gray-500 uppercase tracking-wide">‡∏°‡∏≤‡∏™‡∏≤‡∏¢</th>
                  <th class="px-3 py-3 text-right text-xs font-semibold text-gray-500 uppercase tracking-wide">‡∏•‡∏≤</th>
                  <th class="px-3 py-3 text-right text-xs font-semibold text-gray-500 uppercase tracking-wide">‡∏Ç‡∏≤‡∏î</th>
                  <th class="px-3 py-3 text-right text-xs font-semibold text-gray-500 uppercase tracking-wide">% ‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô</th>
                </tr>
              </thead>
              <tbody id="summary-dept-tbody" class="divide-y divide-gray-100"></tbody>
            </table>
          </div>
        </div>

      </div>
    </div>

    <!-- Success Modal -->
    <div id="success-modal" class="modal">
      <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
        <div class="text-center">
          <div class="text-6xl mb-4">‚úì</div>
          <h3 class="text-2xl font-bold text-green-600 mb-2">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</h3>
          <div id="modal-summary" class="text-gray-600 mb-4"></div>
          <button id="close-modal-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg">‡∏õ‡∏¥‡∏î</button>
        </div>
      </div>
    </div>

  </div>

<script>
  const defaultConfig = {
    company_name: "Gosoft.co.th",
    department_name: "Techncal service support",
    manager_name: "Putinan Suramarna",
  };

  const today = new Date();
  const todayISO = today.toISOString().split('T')[0];

  let employees = [];
  let attendanceRecords = [];
  let currentDate = todayISO;

  let currentAttendance = {};
  let checkInTimes = {};
  let checkOutTimes = {};

  let displayRecords = [];
  let chartStatusTodayInstance = null;
  let lateTrendChartInstance = null;

  const ADV_PAGE_SIZE = 7;
  let advCurrentPage = 1;
  let advFilteredRecords = [];

  let summaryStartDate = '';
  let summaryEndDate = '';

  // =========================================================
  // ‚úÖ ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà 1: ‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ Google Sheet (no-cors)
  // =========================================================
  async function sendToGoogleSheet(rows) {
    try {
      await fetch('https://script.google.com/macros/s/AKfycbzhWV15TAvFkm2pkVdrN5BZ9sT1k2yWlks3_jmN5eAHQh4muLXi-UCHRQXHGxzKMnNErQ/exec', {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ rows })  // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö JSON
      });
      return true;
    } catch (err) {
      console.error("Send to Google Sheet failed:", err);
      return false;
    }
  }
  const dataHandler = {
    onDataChanged(data) {
      attendanceRecords = Array.isArray(data) ? data : [];
      refreshDisplayRecords();
      updateSummaryView();
      updateHistoryView();
      applyAdvancedFilters();
    }
  };

  async function onConfigChange(config) {
    const companyName = config.company_name || defaultConfig.company_name;
    const departmentName = config.department_name || defaultConfig.department_name;
    const managerName = config.manager_name || defaultConfig.manager_name;

    document.getElementById('company-name').textContent = companyName;
    document.getElementById('department-name').textContent = departmentName;
    document.getElementById('manager-name').textContent = managerName;
  }

  async function initializeApp() {
    if (window.dataSdk) {
      const initResult = await window.dataSdk.init(dataHandler);
      if (!initResult.isOk) console.error("Failed to initialize data SDK");
    }

    if (window.elementSdk) {
      await window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities: () => ({
          recolorables: [],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (config) => new Map([
          ["company_name", config.company_name || defaultConfig.company_name],
          ["department_name", config.department_name || defaultConfig.department_name],
          ["manager_name", config.manager_name || defaultConfig.manager_name],
        ])
      });
    }

    initializeDefaultEmployees();
    setupEventListeners();
    setupAdvancedHistoryEvents();
    setupSummaryFilterEvents();
    updateCurrentTime();
    setInterval(updateCurrentTime, 1000);

    document.getElementById('attendance-date').value = currentDate;
    renderAttendanceList();

    refreshDisplayRecords();
    updateSummaryView();
    updateHistoryView();
    applyAdvancedFilters();
  }

  function initializeDefaultEmployees() {
    employees = [
      { id: '123452', name: 'Achirawit Jongsamai', position: 'Senior', department: 'Technical support', photo:'images/chi.jpg'},
      { id: '123453', name: 'Chanatip Mongkolyos', position: 'Senior', department: 'Technical support', photo:'images/ice.jpg' },
      { id: '123454', name: 'Chaiyot Ekpunyachai', position: 'Expert', department: 'Technical support', photo:'images/yot.jpg' },
      { id: '123455', name: 'Isorn Srisoongnoen', position: 'Expert', department: 'Technical support', photo:'images/koe.jpg' },
      { id: '123456', name: 'Kawinthida Kerdsritong', position: 'Senior', department: 'Cloud Engineer', photo:'images/diw.jpg' },
      { id: '123457', name: 'Korn Tammapanit', position: 'Senior', department: 'Technical support', photo:'images/annant.jpg' },
      { id: '123458', name: 'Kittithorn Jetsikatud', position: 'Senior', department: 'Technical support', photo:'images/new.jpg' },
      { id: '123459', name: 'Massupa Suthapot', position: 'Senior', department: 'Technical support', photo:'images/kaew.jpg' },
      { id: '123450', name: 'Natthapon Suwannapare', position: 'Senior', department: 'Cloud Engineer', photo:'images/diw1.jpg' },
      { id: '123411', name: 'Phrmphon Phanitdi', position: 'GOS', department: 'Technical support', photo:'images/erk.jpg' },
      { id: '123412', name: 'Paphawarin Naewpranit', position: 'GOS', department: 'Cloud Engineer', photo:'images/pocky.jpg' },
      { id: '123413', name: 'Phanuphong Seehad', position: 'GOS', department: 'Technical support', photo:'images/den.jpg' },
      { id: '123414', name: 'Panuwat Chomlit', position: 'Senior', department: 'Technical support', photo:'images/oat.jpg' },
      { id: '123415', name: 'Pongwalai Usabuy', position: 'Senior', department: 'Technical support', photo:'images/nam.jpg' },
      { id: '123416', name: 'Phachara Sapphayanon', position: 'Senior', department: 'Technical support', photo:'images/p.jpg' },
      { id: '123417', name: 'Phanuphan Fairee', position: 'Senior', department: 'Technical support', photo:'images/ton.jpg' },
      { id: '123418', name: 'Ronnayut Khantarasha', position: 'Specialist', department: 'Technical support', photo:'images/jack.jpg' },
      { id: '123419', name: 'Sarun Thepnamwong', position: 'Expert', department: 'Cloud Engineer', photo:'images/nong.jpg' },
      { id: '123420', name: 'Sawanya Pholreungwilaiseng', position: 'Senior', department: 'Technical support', photo:'images/pok.jpg' },
      { id: '123421', name: 'Suchada Poonketkit', position: 'Senior', department: 'Cloud Engineer', photo:'images/da.jpg' },
      { id: '123422', name: 'Soravee Mekchai', position: 'Expert', department: 'Technical support', photo:'images/fon.jpg' },
      { id: '123423', name: 'Teerapat Emsem', position: 'Senior', department: 'Technical support', photo:'images/gob.jpg' },
      { id: '123424', name: 'Teerachai Leewan', position: 'Expert', department: 'Technical support', photo:'images/tom.jpg' },
      { id: '123425', name: 'Wathit Chantree', position: 'Senior', department: 'Technical support', photo:'images/thit.jpg' },
      { id: '123426', name: 'Wisanpon Authasit', position: 'Senior', department: 'Technical support', photo:'images/bank.jpg' },
      { id: '123427', name: 'Wisit Winyutrakul', position: 'Expert', department: 'Technical support', photo:'images/k.jpg' },
      { id: '123428', name: 'Yuthasilp Chotdee', position: 'Expert', department: 'Technical support', photo:'images/tua.jpg' }
    ];
    renderEmployeesList();
  }

  function setupEventListeners() {
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => switchTab(btn.dataset.tab));
    });

    document.getElementById('attendance-date').addEventListener('change', (e) => {
      currentDate = e.target.value;
      currentAttendance = {};
      checkInTimes = {};
      checkOutTimes = {};
      renderAttendanceList();
    });

    document.getElementById('save-attendance-btn').addEventListener('click', saveAttendance);
    document.getElementById('add-employee-form').addEventListener('submit', addEmployee);
    document.getElementById('close-modal-btn').addEventListener('click', closeModal);
  }

  function switchTab(tabName) {
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.classList.remove('text-indigo-600','border-b-2','border-indigo-600');
      btn.classList.add('text-gray-600');
    });

    const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
    if (activeBtn) {
      activeBtn.classList.add('text-indigo-600','border-b-2','border-indigo-600');
      activeBtn.classList.remove('text-gray-600');
    }

    document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
    const activeTab = document.getElementById(`tab-${tabName}`);
    if (activeTab) activeTab.classList.remove('hidden');

    if (tabName === 'employees') renderEmployeesList();
    if (tabName === 'history') { updateHistoryView(); applyAdvancedFilters(); }
    if (tabName === 'summary') updateSummaryView();
  }

  function updateCurrentTime() {
    const now = new Date();
    const timeStrFull = now.toLocaleString('th-TH', {
      year:'numeric', month:'long', day:'numeric',
      hour:'2-digit', minute:'2-digit', second:'2-digit'
    });
    const timeStrShort = now.toLocaleTimeString('th-TH', {
      hour:'2-digit', minute:'2-digit', second:'2-digit'
    });

    const timeElement = document.getElementById('current-time');
    if (timeElement) timeElement.textContent = timeStrFull;

    const timeInline = document.getElementById('current-time-inline');
    if (timeInline) timeInline.textContent = timeStrShort;
  }

  function formatTimeHM(isoStr) {
    if (!isoStr) return '-';
    const d = new Date(isoStr);
    if (isNaN(d)) return '-';
    const hh = String(d.getHours()).padStart(2,'0');
    const mm = String(d.getMinutes()).padStart(2,'0');
    return `${hh}:${mm}`;
  }

  function renderAttendanceList() {
    const container = document.getElementById('attendance-list');
    container.innerHTML = '';

    employees.forEach((employee) => {
      const status = currentAttendance[employee.id] || '';
      const statusClass = status ? `status-${status}` : '';

      const card = document.createElement('div');
      card.className = `bg-white rounded-lg shadow-md p-4 transition-all ${statusClass}`;

      card.innerHTML = `
        <div class="flex flex-col sm:flex-row gap-4">
          <div class="flex items-center gap-4 flex-1">
            <div class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center overflow-hidden flex-shrink-0">
              <img src="${employee.photo || ''}" alt="photo" class="w-full h-full object-cover">
            </div>
            <div class="flex-1">
              <div class="font-bold text-lg text-gray-800">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ${employee.id}</div>
              <div class="text-gray-600">${employee.name}</div>
              <div class="text-sm text-gray-500">${employee.position} - ${employee.department}</div>
            </div>
          </div>

          <div class="w-full sm:w-auto flex flex-col items-stretch sm:items-end gap-2">
            <div class="flex flex-col md:flex-row md:flex-wrap gap-2 w-full md:justify-end">
              <button class="btn-status w-full md:w-auto px-4 py-2 rounded-lg font-semibold ${status === 'present' ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-700'}" onclick="setAttendance('${employee.id}','present')">‡πÄ‡∏Ç‡πâ‡∏≤ office</button>
              <button class="btn-status w-full md:w-auto px-4 py-2 rounded-lg font-semibold ${status === 'absent' ? 'bg-red-500 text-white' : 'bg-gray-200 text-gray-700'}" onclick="setAttendance('${employee.id}','absent')">wfh</button>
              <button class="btn-status w-full md:w-auto px-4 py-2 rounded-lg font-semibold ${status === 'leave' ? 'bg-yellow-500 text-white' : 'bg-gray-200 text-gray-700'}" onclick="setAttendance('${employee.id}','leave')">‡∏•‡∏≤‡∏á‡∏≤‡∏ô</button>
              <button class="btn-status w-full md:w-auto px-4 py-2 rounded-lg font-semibold ${status === 'late' ? 'bg-orange-500 text-white' : 'bg-gray-200 text-gray-700'}" onclick="setAttendance('${employee.id}','late')">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≤‡∏¢</button>
            </div>
          </div>
        </div>

        <div class="mt-3">
          <textarea class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" rows="2" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏....." id="note-${employee.id}"></textarea>
        </div>
      `;

      container.appendChild(card);
    });

    updateCounts();
  }

  function checkIn(employeeId) {
    const now = new Date();
    const [y,m,d] = currentDate.split('-');
    const check = new Date(now);
    check.setFullYear(parseInt(y), parseInt(m)-1, parseInt(d));
    const iso = check.toISOString();

    checkInTimes[employeeId] = iso;

    const standard = new Date(check);
    standard.setHours(9,0,0,0);

    currentAttendance[employeeId] = (check <= standard) ? 'present' : 'late';
    renderAttendanceList();
  }

  function checkOut(employeeId) {
    const now = new Date();
    const [y,m,d] = currentDate.split('-');
    const check = new Date(now);
    check.setFullYear(parseInt(y), parseInt(m)-1, parseInt(d));
    checkOutTimes[employeeId] = check.toISOString();
    renderAttendanceList();
  }

  function setAttendance(employeeId, status) {
    currentAttendance[employeeId] = status;
    renderAttendanceList();
  }

  function updateCounts() {
    const counts = { present:0, absent:0, leave:0, late:0 };
    Object.values(currentAttendance).forEach(s => { if (counts[s] !== undefined) counts[s]++; });
    document.getElementById('count-present').textContent = counts.present;
    document.getElementById('count-absent').textContent = counts.absent;
    document.getElementById('count-leave').textContent = counts.leave;
    document.getElementById('count-late').textContent = counts.late;
  }

  async function saveAttendance() {
    const btn = document.getElementById('save-attendance-btn');
    const loading = btn.querySelector('.loading');
    loading.classList.add('active');
    btn.disabled = true;

    const timestamp = new Date().toISOString();
    const newRecords = [];

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏ô
    for (const employee of employees) {
      let status = currentAttendance[employee.id] || '';
      const note = document.getElementById(`note-${employee.id}`)?.value || '';
      const checkInTime = checkInTimes[employee.id] || '';
      const checkOutTime = checkOutTimes[employee.id] || '';

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô
      if (!status && checkInTime) {
        const dIn = new Date(checkInTime);
        const standard = new Date(dIn);
        standard.setHours(9,0,0,0);
        status = dIn <= standard ? 'present' : 'late';
      }

      // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô 'absent'
      if (!status && !checkInTime && !checkOutTime) {
        status = 'absent';
      }

      let workHours = '';
      if (checkInTime && checkOutTime) {
        const diffMs = new Date(checkOutTime) - new Date(checkInTime);
        if (diffMs > 0) workHours = (diffMs / (1000*60*60)).toFixed(2);
      }

      const record = {
        employee_id: employee.id,
        attendance_date: currentDate,
        status,
        note,
        timestamp,
        check_in_time: checkInTime,
        check_out_time: checkOutTime,
        work_hours: workHours
      };

      attendanceRecords.push(record);
      newRecords.push(record);
    }

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Sheets
    const sheetRows = newRecords.map(r => ({
      emp_id: r.employee_id,
      full_name: (employees.find(e => e.id === r.employee_id)?.name) || "",
      status: r.status,               // present/absent/leave/late
      location: "Office",             // ‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô GPS ‡∏Å‡πá‡πÑ‡∏î‡πâ
      note: r.note || "",
      device: navigator.userAgent
    }));

    // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Sheets
    if (sheetRows.length > 0) {
      const ok = await sendToGoogleSheet(sheetRows);
      if (!ok) alert("‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤ Google Sheet ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏î‡∏π Console)");
    }

    loading.classList.remove('active');
    btn.disabled = false;

    // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
    showSuccessModal();
  }


  function showSuccessModal() {
    const counts = { present:0, absent:0, leave:0, late:0 };
    Object.values(currentAttendance).forEach(s => { if (counts[s] !== undefined) counts[s]++; });
    const total = Object.values(counts).reduce((a,b)=>a+b,0);
    const percentage = total > 0 ? ((counts.present / total) * 100).toFixed(1) : 0;

    const summary = `
      <div class="text-left space-y-2">
        <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${new Date(currentDate).toLocaleDateString('th-TH',{year:'numeric',month:'long',day:'numeric'})}</p>
        <p><strong>‡πÄ‡∏Ç‡πâ‡∏≤ office:</strong> ${counts.present} ‡∏Ñ‡∏ô</p>
        <p><strong>wfh:</strong> ${counts.absent} ‡∏Ñ‡∏ô</p>
        <p><strong>‡∏•‡∏≤‡∏á‡∏≤‡∏ô:</strong> ${counts.leave} ‡∏Ñ‡∏ô</p>
        <p><strong>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≤‡∏¢:</strong> ${counts.late} ‡∏Ñ‡∏ô</p>
        <p class="text-xl font-bold text-indigo-600 mt-3">‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡πÄ‡∏Ç‡πâ‡∏≤ office: ${percentage}%</p>
      </div>
    `;

    document.getElementById('modal-summary').innerHTML = summary;
    document.getElementById('success-modal').classList.add('active');

    currentAttendance = {};
    checkInTimes = {};
    checkOutTimes = {};
    renderAttendanceList();
  }

  function closeModal() {
    document.getElementById('success-modal').classList.remove('active');
  }

  async function addEmployee(e) {
    e.preventDefault();
    const btn = e.target.querySelector('button[type="submit"]');
    const loading = btn.querySelector('.loading');
    loading.classList.add('active');
    btn.disabled = true;

    const id = document.getElementById('new-employee-id').value.trim();
    const name = document.getElementById('new-employee-name').value.trim();
    const position = document.getElementById('new-employee-position').value.trim();
    const department = document.getElementById('new-employee-department').value.trim();

    employees.push({ id, name, position, department, photo: '' });

    document.getElementById('add-employee-form').reset();
    renderEmployeesList();
    renderAttendanceList();

    loading.classList.remove('active');
    btn.disabled = false;

    showToast("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
  }

  function renderEmployeesList() {
    const container = document.getElementById('employees-list');
    if (!container) return;
    container.innerHTML = '';

    employees.forEach((employee, index) => {
      const card = document.createElement('div');
      card.className = 'bg-gray-50 rounded-lg p-4 flex items-center gap-4';

      card.innerHTML = `
        <div class="w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center overflow-hidden flex-shrink-0">
          <img src="${employee.photo || ''}" alt="photo" class="w-full h-full object-cover">
        </div>
        <div class="flex-1">
          <div class="font-bold text-gray-800">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ${employee.id}</div>
          <div class="text-gray-600">${employee.name}</div>
          <div class="text-sm text-gray-500">${employee.position} - ${employee.department}</div>
        </div>
        <button class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-semibold" onclick="deleteEmployee(${index})">‡∏•‡∏ö</button>
      `;

      container.appendChild(card);
    });
  }

  function deleteEmployee(index) {
    employees.splice(index, 1);
    renderEmployeesList();
    renderAttendanceList();
    showToast("‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
  }

  function showToast(message) {
    const toast = document.createElement('div');
    toast.className = 'fixed top-4 right-4 bg-indigo-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }

  function formatDateThai(dateStr) {
    if (!dateStr) return '-';
    const d = new Date(dateStr);
    if (isNaN(d)) return dateStr;
    const months = ['‡∏°.‡∏Ñ.','‡∏Å.‡∏û.','‡∏°‡∏µ.‡∏Ñ.','‡πÄ‡∏°.‡∏¢.','‡∏û.‡∏Ñ.','‡∏°‡∏¥.‡∏¢.','‡∏Å.‡∏Ñ.','‡∏™.‡∏Ñ.','‡∏Å.‡∏¢.','‡∏ï.‡∏Ñ.','‡∏û.‡∏¢.','‡∏ò.‡∏Ñ.'];
    return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear() + 543}`;
  }

  function getDatesInRange(startStr, endStr) {
    const result = [];
    if (!startStr || !endStr) return result;
    const start = new Date(startStr);
    const end = new Date(endStr);
    if (isNaN(start) || isNaN(end)) return result;

    let s = start, e = end;
    if (s > e) { const tmp = s; s = e; e = tmp; }
    for (let d = new Date(s); d <= e; d.setDate(d.getDate() + 1)) result.push(new Date(d));
    return result;
  }

  function refreshDisplayRecords() {
    displayRecords = attendanceRecords.map(r => {
      const emp = employees.find(e => e.id === r.employee_id);
      const name = emp ? emp.name : r.employee_id;
      const dept = emp ? emp.department : '';
      const dateStr = r.attendance_date || (r.timestamp ? r.timestamp.split('T')[0] : '');
      return {
        empId: r.employee_id,
        name,
        dept,
        status: (r.status || '').toLowerCase(),
        date: dateStr,
        timestamp: r.timestamp || (dateStr ? dateStr + ' 00:00' : ''),
        checkInTime: r.check_in_time || '',
        checkOutTime: r.check_out_time || '',
        workHours: r.work_hours || ''
      };
    });
    advFilteredRecords = [...displayRecords];
  }

  function setupSummaryFilterEvents() {
    const startEl = document.getElementById('summary-start-date');
    const endEl = document.getElementById('summary-end-date');
    const resetEl = document.getElementById('summary-range-reset');

    if (startEl) startEl.addEventListener('change', () => { summaryStartDate = startEl.value; updateSummaryView(); });
    if (endEl) endEl.addEventListener('change', () => { summaryEndDate = endEl.value; updateSummaryView(); });

    if (resetEl) resetEl.addEventListener('click', () => {
      summaryStartDate = ''; summaryEndDate = '';
      if (startEl) startEl.value = '';
      if (endEl) endEl.value = '';
      updateSummaryView();
    });
  }

  function updateSummaryView() {
    let rangeStart, rangeEnd;
    let rangeLabelText = '';

    if (!summaryStartDate && !summaryEndDate) {
      rangeStart = todayISO;
      rangeEnd = todayISO;
      rangeLabelText = `‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (${formatDateThai(todayISO)})`;
    } else {
      rangeStart = summaryStartDate || summaryEndDate;
      rangeEnd = summaryEndDate || summaryStartDate;
      if (rangeStart > rangeEnd) { const tmp = rangeStart; rangeStart = rangeEnd; rangeEnd = tmp; }
      rangeLabelText = `‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ${formatDateThai(rangeStart)} - ${formatDateThai(rangeEnd)}`;
    }

    const rangeLabelEl = document.getElementById('summary-range-label');
    if (rangeLabelEl) rangeLabelEl.textContent = rangeLabelText;

    const recsForSummary = displayRecords.filter(r => {
      if (!r.date) return false;
      if (rangeStart && r.date < rangeStart) return false;
      if (rangeEnd && r.date > rangeEnd) return false;
      return true;
    });

    const totalEmp = new Set(recsForSummary.map(r => r.empId)).size;
    const presentCnt = recsForSummary.filter(r => r.status === 'present').length;
    const lateCnt = recsForSummary.filter(r => r.status === 'late').length;
    const leaveCnt = recsForSummary.filter(r => r.status === 'leave').length;
    const absentCnt = recsForSummary.filter(r => r.status === 'absent').length;

    document.getElementById('sum-total-emp').textContent = totalEmp || '-';
    document.getElementById('sum-present-today').textContent = presentCnt;
    document.getElementById('sum-late-today').textContent = lateCnt;
    document.getElementById('sum-leave-absent-today').textContent = leaveCnt + absentCnt;

    const statusCanvas = document.getElementById('chart-status-today');
    if (statusCanvas && typeof Chart !== 'undefined') {
      const ctxStatus = statusCanvas.getContext('2d');
      if (chartStatusTodayInstance) chartStatusTodayInstance.destroy();
      chartStatusTodayInstance = new Chart(ctxStatus, {
        type: 'doughnut',
        data: {
          labels: ['‡∏ï‡∏£‡∏á‡πÄ‡∏ß‡∏•‡∏≤','‡∏°‡∏≤‡∏™‡∏≤‡∏¢','‡∏•‡∏≤','‡∏Ç‡∏≤‡∏î'],
          datasets: [{ data: [presentCnt, lateCnt, leaveCnt, absentCnt] }]
        },
        options: {
          plugins: { legend: { position: 'bottom' } },
          maintainAspectRatio: false
        }
      });
    }

    const dateObjs = getDatesInRange(rangeStart, rangeEnd);
    const labels = [];
    const lateCounts = [];

    dateObjs.forEach(d => {
      const iso = d.toISOString().slice(0,10);
      labels.push(`${d.getDate()}/${d.getMonth()+1}`);
      lateCounts.push(displayRecords.filter(r => r.date === iso && r.status === 'late').length);
    });

    const lateCanvas = document.getElementById('chart-late-trend');
    if (lateCanvas && typeof Chart !== 'undefined') {
      const ctxLate = lateCanvas.getContext('2d');
      if (lateTrendChartInstance) lateTrendChartInstance.destroy();
      lateTrendChartInstance = new Chart(ctxLate, {
        type: 'bar',
        data: { labels, datasets: [{ label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡∏≤‡∏™‡∏≤‡∏¢', data: lateCounts }] },
        options: { plugins: { legend: { display:false } }, maintainAspectRatio:false, scales: { y: { beginAtZero:true, ticks:{ stepSize:1 } } } }
      });
    }

    const tbody = document.getElementById('summary-dept-tbody');
    if (tbody) {
      const deptMap = {};
      recsForSummary.forEach(rec => {
        const dept = rec.dept || '-';
        if (!deptMap[dept]) deptMap[dept] = { present:0, late:0, leave:0, absent:0 };
        if (deptMap[dept][rec.status] !== undefined) deptMap[dept][rec.status]++;
      });

      tbody.innerHTML = '';
      const depts = Object.keys(deptMap);
      if (!depts.length) {
        tbody.innerHTML = `<tr><td colspan="6" class="px-3 py-4 text-center text-xs text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</td></tr>`;
        return;
      }

      depts.forEach(dept => {
        const d = deptMap[dept];
        const total = d.present + d.late + d.leave + d.absent;
        const attend = d.present + d.late;
        const percent = total ? ((attend/total)*100).toFixed(1) : '0.0';

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-3 py-2 text-gray-800 font-medium">${dept}</td>
          <td class="px-3 py-2 text-right text-emerald-600 font-semibold">${d.present}</td>
          <td class="px-3 py-2 text-right text-amber-500 font-semibold">${d.late}</td>
          <td class="px-3 py-2 text-right text-sky-600 font-semibold">${d.leave}</td>
          <td class="px-3 py-2 text-right text-rose-500 font-semibold">${d.absent}</td>
          <td class="px-3 py-2 text-right text-gray-800 font-semibold">${percent}%</td>
        `;
        tbody.appendChild(tr);
      });
    }
  }

  function updateHistoryView() {
    renderAdvancedHistoryTable();
  }

  function setupAdvancedHistoryEvents() {
    const dateEl = document.getElementById('history-date');
    const statusEl = document.getElementById('history-status');
    const deptEl = document.getElementById('history-dept');
    const searchEl = document.getElementById('history-search');
    const prevEl = document.getElementById('history-prev');
    const nextEl = document.getElementById('history-next');

    if (dateEl) dateEl.addEventListener('change', applyAdvancedFilters);
    if (statusEl) statusEl.addEventListener('change', applyAdvancedFilters);
    if (deptEl) deptEl.addEventListener('change', applyAdvancedFilters);
    if (searchEl) searchEl.addEventListener('input', applyAdvancedFilters);

    if (prevEl) prevEl.addEventListener('click', () => { if (advCurrentPage > 1) { advCurrentPage--; renderAdvancedHistoryTable(); } });
    if (nextEl) nextEl.addEventListener('click', () => {
      const totalPages = Math.max(1, Math.ceil(advFilteredRecords.length / ADV_PAGE_SIZE));
      if (advCurrentPage < totalPages) { advCurrentPage++; renderAdvancedHistoryTable(); }
    });
  }

  function applyAdvancedFilters() {
    const dateVal = document.getElementById('history-date')?.value || '';
    const statusVal = document.getElementById('history-status')?.value || '';
    const deptVal = document.getElementById('history-dept')?.value || '';
    const searchVal = (document.getElementById('history-search')?.value || '').trim().toLowerCase();

    advFilteredRecords = displayRecords.filter(rec => {
      if (dateVal && rec.date !== dateVal) return false;
      if (statusVal && rec.status !== statusVal) return false;
      if (deptVal && rec.dept !== deptVal) return false;
      if (searchVal) {
        const text = (rec.empId + ' ' + rec.name).toLowerCase();
        if (!text.includes(searchVal)) return false;
      }
      return true;
    });

    advCurrentPage = 1;
    renderAdvancedHistoryTable();
  }

  const STATUS_TEXT = { present:'‡πÄ‡∏Ç‡πâ‡∏≤ office', late:'‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≤‡∏¢', leave:'‡∏•‡∏≤', absent:'wfh' };
  const STATUS_BADGE = {
    present: 'inline-flex px-2 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700',
    late:    'inline-flex px-2 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-700',
    leave:   'inline-flex px-2 py-0.5 rounded-full text-xs font-medium bg-sky-100 text-sky-700',
    absent:  'inline-flex px-2 py-0.5 rounded-full text-xs font-medium bg-rose-100 text-rose-700',
  };

  function renderAdvancedHistoryTable() {
    const tbody = document.getElementById('history-tbody');
    if (!tbody) return;

    tbody.innerHTML = '';
    const total = advFilteredRecords.length;
    const totalPages = Math.max(1, Math.ceil(total / ADV_PAGE_SIZE));
    if (advCurrentPage > totalPages) advCurrentPage = totalPages;

    const startIdx = (advCurrentPage - 1) * ADV_PAGE_SIZE;
    const pageData = advFilteredRecords.slice(startIdx, startIdx + ADV_PAGE_SIZE);

    if (!pageData.length) {
      tbody.innerHTML = '<tr><td colspan="8" class="px-3 py-6 text-center text-sm text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</td></tr>';
    } else {
      pageData.forEach(rec => {
        const inStr = formatTimeHM(rec.checkInTime);
        const outStr = formatTimeHM(rec.checkOutTime);
        const workStr = rec.workHours ? `${rec.workHours} ‡∏ä‡∏°.` : '-';

        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50';
        tr.innerHTML = `
          <td class="px-3 py-2 text-gray-700">${formatDateThai(rec.date)}</td>
          <td class="px-3 py-2 text-gray-700">${rec.empId}</td>
          <td class="px-3 py-2 text-gray-800 font-medium">${rec.name}</td>
          <td class="px-3 py-2 text-gray-600">${rec.dept || '-'}</td>
          <td class="px-3 py-2 text-gray-700">${inStr}</td>
          <td class="px-3 py-2 text-gray-700">${outStr}</td>
          <td class="px-3 py-2"><span class="${STATUS_BADGE[rec.status] || ''}">${STATUS_TEXT[rec.status] || rec.status}</span></td>
          <td class="px-3 py-2 text-right text-gray-800 font-semibold">${workStr}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    const summaryText = document.getElementById('history-summary-text');
    if (summaryText) summaryText.textContent = `‡πÅ‡∏™‡∏î‡∏á ${pageData.length ? startIdx + 1 : 0}‚Äì${startIdx + pageData.length} ‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${total} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;

    const pageLabel = document.getElementById('history-page-label');
    if (pageLabel) pageLabel.textContent = `‡∏´‡∏ô‡πâ‡∏≤ ${advCurrentPage} / ${totalPages}`;

    const prevBtn = document.getElementById('history-prev');
    const nextBtn = document.getElementById('history-next');
    if (prevBtn) prevBtn.disabled = advCurrentPage === 1;
    if (nextBtn) nextBtn.disabled = advCurrentPage === totalPages;
  }

  // export ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å HTML
  window.setAttendance = setAttendance;
  window.deleteEmployee = deleteEmployee;
  window.checkIn = checkIn;
  window.checkOut = checkOut;

  document.addEventListener('DOMContentLoaded', initializeApp);
</script>

</body>
</html>

